= errtrace
:toc: preamble
:idprefix:
:idseparator: -

image::assets/logo.png[errtrace logo,300,align="center"]

== Introduction

[WARNING]
errtrace is extremely experimental.
Use it at your own risk.

errtrace is an experimental package to trace an error's return path
through a Go program.

Rather than providing a stack trace
showing the _inwards_ route that caused an error,
errtrace lets you track the _outwards_ route that the error took
until you ultimately handle it.
We believe that this can be more useful than a plain stack trace
for complex programs written in Go.

=== Features

Lightweight::
  errtrace brings no other runtime dependencies with it.
<<Manual instrumentation,Simple>>::
  The library API is simple, straightforward, and idiomatic.
<<Automatic instrumentation,Easy>>::
  The errtrace CLI will automatically instrument your code.
<<Performance,Fast>>::
  On popular 64-bit systems,
  errtrace is much faster than capturing a stack trace.

=== Why

In languages like Go where errors are values,
users have the ability to store the error in a struct,
pass it through a channel, etc.

This can result in a situation where a stack trace,
which records the path _to the error_,
loses some usefulness as it moves through the program
before it's surfaced to the user.

We believe that for such programs,
it can be more useful and more performant
to have the return trace instead:
the path the error took _out_ to get to the user.

This library is an experiment to evaluate that idea.

=== Installation

Install errtrace with Go modules:

[source,bash]
----
go get braces.dev/errtrace@latest
----

If you want to use the CLI, use `go install`.

[source,bash]
----
go install braces.dev/errtrace/cmd/errtrace@latest
----

== Usage

errtrace offers the following modes of usage:

* <<Manual instrumentation>>
* <<Automatic instrumentation>>

=== Manual instrumentation

[source,go]
----
import "braces.dev/errtrace"
----

Under manual instrumentation,
you're expected to import errtrace,
and wrap errors at all return sites like so:

[source,go]
----
// ...
if err != nil {
    return errtrace.Wrap(err)
}
----

.Example
[%collapsible]
====
Given a function like the following:

[source,go]
----
func writeToFile(path string, src io.Reader) error {
  dst, err := os.Create(path)
  if err != nil {
    return err
  }
  defer dst.Close()

  if _, err := io.Copy(dst, src); err != nil {
    return err
  }

  return nil
}
----

With errtrace, you'd change it to:

[source,go]
----
func writeToFile(path string, src io.Reader) error {
  dst, err := os.Create(path)
  if err != nil {
    return errtrace.Wrap(err)
  }
  defer dst.Close()

  if _, err := io.Copy(dst, src); err != nil {
    return errtrace.Wrap(err)
  }

  return nil
}
----

[NOTE]
It's important that the `errtrace.Wrap` function is called
inside the same function that's actually returning the error.
A helper function will not suffice.
====

=== Automatic instrumentation

If manual instrumentation is too much work (we agree),
we've included a tool that will automatically instrument
all your code with errtrace.

First, <<Installation,install the tool>>.
Then, run it on your code:

[source,bash]
----
errtrace -w path/to/file.go path/to/another/file.go
----

To run it on all non-test Go files in your project,
if you use Git, run the following command on a Unix-like system:

[source,bash]
----
git ls-files -- '*.go' ':!:*_test.go' | xargs errtrace -w
----

errtrace can be set be setup as a custom formatter in your editor,
similar to gofmt or goimports.

== Performance

errtrace is designed to have very low overhead
on supported systems.

Benchmark results for linux/amd64 on an Intel Core i5-13600 (best of 10):

....
BenchmarkFmtErrorf      11574928               103.5 ns/op            40 B/op          2 allocs/op
# default build, uses Go assembly.
BenchmarkWrap           78173496                14.70 ns/op           24 B/op          0 allocs/op
# build with -tags safe to avoid assembly.
BenchmarkWrap            5958579               198.5 ns/op            24 B/op          0 allocs/op

# benchext compares capturing stacks using pkg/errors vs errtrace
# both tests capture ~10 frames,
BenchmarkErrtrace        6388651               188.4 ns/op           280 B/op          1 allocs/op
BenchmarkPkgErrors       1673145               716.8 ns/op           304 B/op          3 allocs/op
....

Stack traces have a large initial cost,
while errtrace scales with each frame that an error is returned through.

== Caveats

=== Error wrapping

errtrace operates by wrapping your errors to add caller information.

==== Matching errors

As a result of errtrace's error wrapping,
wrapped errors cannot be matched directly with `==`.

[source,go]
----
fmt.Println(err == err)                // true
fmt.Println(errtrace.Wrap(err) == err) // false
----

To match these wrapped errors, use the standard library's
https://pkg.go.dev/errors#Is[errors.Is] function.

[source,go]
----
fmt.Println(errors.Is(errtrace.Wrap(err), err)) // true
----

==== Casting errors

Similarly, as a result of errtrace's error wrapping,
wrapped errors cannot be type-cast directly.

[source,go]
----
my, ok := err.(*MyError)                // ok = true
my, ok := errtrace.Wrap(err).(*MyError) // ok = false
----

To type-cast wrapped errors, use the standard library's
https://pkg.go.dev/errors#As[errors.As] function.

[source,go]
----
var my *MyError
ok := errors.As(errtrace.Wrap(err), &my) // ok = true
----

==== Linting

You can use https://github.com/polyfloyd/go-errorlint[go-errorlint]
to find places in your code
where you're comparing errors with `==` instead of using `errors.Is`
or type-casting them directly instead of using `errors.As`.

=== Safety

To achieve the performance above,
errtrace makes use of unsafe operations using Go assembly
to read the caller information directly from the stack.
This is part of the reason why we have the disclaimer on top.

errtrace includes an opt-in safe mode
that drops these unsafe operations in exchange for poorer performance.
To opt into safe mode,
use the `safe` build tag when compiling code that uses errtrace.

[source,bash]
----
go build -tags safe
----

== Acknowledgements

The idea of tracing return paths instead of stack traces
comes from https://ziglang.org/documentation/0.11.0/#Error-Return-Traces[Zig's error return traces].

== License

This software is made available under the BSD3 license.
See LICENSE file for details.
